/// <reference path="./Meet.d.ts" />

import { defineComponent, Fragment, onMounted, onUnmounted } from "vue";
import "./Meet.scss";
import { Motion } from "motion-v";
import Svg from "@/components/Svg/Svg.tsx";
import { MeetRoomController } from "./Meet.controller.ts";
import { useRoute, useRouter } from "vue-router";
import { meetRoomConfig } from "./Meet.config.ts";

export default defineComponent({
  name: "MeetRoom",
  setup() {
    const controller = new MeetRoomController();
    const route = useRoute();
    const router = useRouter();
    
    // 设置路由器实例
    controller.setRouter(router);
    let meetId: string = "";

    onMounted(() => {
      const roomId = route.params.roomId as string;
      if (roomId) {
        meetId = roomId;
        try {
          const numericRoomId = $roomformat.roomIdToNumber(roomId);
          controller.initRoom(roomId, numericRoomId);
        } catch (error: any) {
          $message.error({
            message: '会议ID格式错误: ' + (error?.message || '未知错误'),
          });
        }
      }
    });

    onUnmounted(() => {
      // 组件卸载时，尝试删除内部参与人
      if (meetId) {
        controller.cleanup(meetId).catch(() => {
        });
      }
    });

    return () => {
      // 加载中时显示加载动画
      if (controller.loading.value) {
        return (
          <div class="meet-room">
            <div class="meet-loading">
              <div class="spinner-container">
                <div class="spinner">
                  <div class="spinner">
                    <div class="spinner">
                      <div class="spinner">
                        <div class="spinner">
                          <div class="spinner"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div class="meet-room">
          <div class="meet-main">
          <div id="meet-video" class="meet-video">
            <div
              class="show-participant"
              onClick={() => controller.toggleParticipant()}
            >
              <Motion
                animate={{
                  rotate: controller.showParticipant.value ? 180 : 0,
                }}
                transition={{
                  duration: 0.3,
                  ease: "easeInOut",
                }}
                class="motion-show-participant"
              >
                <Svg
                  svgPath={['M576 672c-6.4 0-19.2 0-25.6-6.4l-128-128c-12.8-12.8-12.8-32 0-44.8l128-128c12.8-12.8 32-12.8 44.8 0s12.8 32 0 44.8L492.8 512l102.4 102.4c12.8 12.8 12.8 32 0 44.8C595.2 672 582.4 672 576 672z']}
                  width="24"
                  height="24"
                  class="icon"
                  fill={'#dddddd'}
                />
              </Motion>
            </div>
          </div>
          <Motion
            initial={{ width: 0, height: "100%", marginLeft: 0 }}
            animate={{
              width: controller.showParticipant.value ? "20%" : 0,
              height: "100%",
              marginLeft: controller.showParticipant.value ? 15 : 0,
              padding: controller.showParticipant.value ? 10 : 0
            }}
            exit={{ width: 0, height: "100%", marginLeft: 0 }}
            transition={{ duration: 0.3, ease: "easeInOut" }}
            class="meet-participant"
          >

            {controller.participantList.value.map(participant => {
                const videoState = controller.getParticipantVideoState(participant.participantId);
                return (
                  <div id={`${participant.participantId}_remote_video`} class="meet-participant-video">
                    {!videoState && (
                      <div class="video-placeholder">
                        <Svg
                          svgPath="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64z m0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z m-32-196h64v-64h-64v64z m0-128h64V320h-64v320z"
                          width="48"
                          height="48"
                          fill="#999999"
                        />
                        <span class="placeholder-text">摄像头已关闭</span>
                      </div>
                    )}
                    <div class="participant-name">{participant.name}</div>
                  </div>
                );
              })}
          </Motion>
        </div>
        <div class="meet-operator">
          <div class="operator-list">
            <div class="operator-item">
              <Svg
                svgPath="M422.709883 333.35325l0 44.623313c0 0-44.667316 42.87653-44.667316 134.042879 0 81.742722 44.667316 133.955898 44.667316 133.955898l0 44.667316c0 0-89.421612-63.816444-89.421612-178.623213C333.288271 392.415414 422.709883 333.35325 422.709883 333.35325zM511.999488 467.267193c-24.645306 0-44.667316 20.019962-44.667316 44.753273 0 24.645306 20.022009 44.666292 44.667316 44.666292s44.621267-20.019962 44.621267-44.666292C556.620755 487.287155 536.644795 467.267193 511.999488 467.267193zM288.623002 512.020466c-1.482771-155.416675 89.419566-223.332485 89.419566-223.332485l0-44.753273c0 0-133.562948 88.415702-134.042879 268.085758-0.479931 179.103144 134.042879 267.998777 134.042879 267.998777l0-44.753273C378.042567 735.26597 290.017768 660.808164 288.623002 512.020466zM601.289094 333.35325l0 44.623313c0 0 44.753273 42.87653 44.753273 134.042879 0 81.742722-44.753273 133.955898-44.753273 133.955898l0 44.667316c0 0 89.419566-63.816444 89.419566-178.623213C690.70866 392.415414 601.289094 333.35325 601.289094 333.35325zM646.042367 243.934708l0 44.753273c0 0 90.772376 67.915809 89.289606 223.332485-1.352811 148.787698-89.289606 223.245504-89.289606 223.245504l0 44.753273c0 0 134.434805-88.895633 133.910872-267.998777C779.518335 332.35041 646.042367 243.934708 646.042367 243.934708zM958.70846 243.934708l0 535.9996c0 98.711186-80.000032 178.709171-178.75522 178.709171L243.998665 958.64348c-98.623181 0-178.709171-79.997985-178.709171-178.709171L65.289494 243.934708c0-98.625228 80.08599-178.579211 178.709171-178.579211l535.954575 0C878.708428 65.355497 958.70846 145.30948 958.70846 243.934708zM869.286848 288.687982c0-74.067926-59.932997-134.042879-133.954875-134.042879L288.623002 154.645103c-73.979922 0-133.912919 59.974953-133.912919 134.042879l0 446.577988c0 74.109882 59.932997 134.086881 133.912919 134.086881l446.708971 0c74.021877 0 133.954875-59.977 133.954875-134.086881L869.286848 288.687982z"
                width="20"
                height="20"
                class="icon"
                fill={meetRoomConfig.networkState[controller.networkState.value as keyof NetworkState].color}
              />
              <span class="tooltip">网络状态：{meetRoomConfig.networkState[controller.networkState.value as keyof NetworkState].status}</span>
            </div>
            <div
              class={["operator-item", { "disabled": !controller.canOpenMicrophone.value }]}
              onClick={() => {
                if (controller.canOpenMicrophone.value) {
                  controller.toggleMicrophone();
                }
              }}
            >
              {controller.canOpenMicrophone.value ? controller.microphoneState.value ? (
                <Fragment>
                  <Svg
                    svgPath="M512 128a128 128 0 0 0-128 128v170.666667a128 128 0 0 0 256 0V256a128 128 0 0 0-128-128z m0-85.333333a213.333333 213.333333 0 0 1 213.333333 213.333333v170.666667a213.333333 213.333333 0 0 1-426.666666 0V256a213.333333 213.333333 0 0 1 213.333333-213.333333zM130.346667 469.333333H216.32a298.752 298.752 0 0 0 591.274667 0h86.016A384.170667 384.170667 0 0 1 554.666667 808.32V981.333333h-85.333334v-173.013333A384.170667 384.170667 0 0 1 130.346667 469.333333z"
                    width="20"
                    height="20"
                    class="icon"
                    fill="#dddddd"
                  />
                  <span class="tooltip">关闭麦克风</span>
                </Fragment>
              ) : (
                <Fragment>
                  <Svg
                    svgPath="M700.8 761.130667A381.482667 381.482667 0 0 1 554.666667 808.32V981.333333h-85.333334v-173.013333A384.170667 384.170667 0 0 1 130.346667 469.333333H216.32a298.752 298.752 0 0 0 421.12 228.437334l-66.176-66.133334A213.333333 213.333333 0 0 1 298.666667 426.666667V358.997333L59.434667 119.808l60.373333-60.373333 844.757333 844.8-60.373333 60.330666-203.392-203.434666z m-315.392-315.392l107.52 107.52a128.085333 128.085333 0 0 1-107.52-107.52z m441.258667 201.088l-61.568-61.525334c21.717333-34.56 36.522667-73.813333 42.538666-115.968h86.016a381.866667 381.866667 0 0 1-66.986666 177.493334z m-124.16-124.117334l-66.048-66.048c2.304-9.642667 3.541333-19.626667 3.541333-29.994666V256a128 128 0 0 0-248.234667-44.032L327.936 148.096A213.333333 213.333333 0 0 1 725.333333 256v170.666667a212.48 212.48 0 0 1-22.784 96.042666z"
                    width="20"
                    height="20"
                    class="icon"
                    fill="#dddddd"
                  />
                  <span class="tooltip">开启麦克风</span>
                </Fragment>
              ) : <Fragment>
                <Svg
                  svgPath="M700.8 761.130667A381.482667 381.482667 0 0 1 554.666667 808.32V981.333333h-85.333334v-173.013333A384.170667 384.170667 0 0 1 130.346667 469.333333H216.32a298.752 298.752 0 0 0 421.12 228.437334l-66.176-66.133334A213.333333 213.333333 0 0 1 298.666667 426.666667V358.997333L59.434667 119.808l60.373333-60.373333 844.757333 844.8-60.373333 60.330666-203.392-203.434666z m-315.392-315.392l107.52 107.52a128.085333 128.085333 0 0 1-107.52-107.52z m441.258667 201.088l-61.568-61.525334c21.717333-34.56 36.522667-73.813333 42.538666-115.968h86.016a381.866667 381.866667 0 0 1-66.986666 177.493334z m-124.16-124.117334l-66.048-66.048c2.304-9.642667 3.541333-19.626667 3.541333-29.994666V256a128 128 0 0 0-248.234667-44.032L327.936 148.096A213.333333 213.333333 0 0 1 725.333333 256v170.666667a212.48 212.48 0 0 1-22.784 96.042666z"
                  width="20"
                  height="20"
                  class="icon-error"
                  fill="#999999"
                />
                <span class="tooltip">麦克风权限未授予</span>
              </Fragment>}
            </div>
            <div
              class={["operator-item", { "disabled": !controller.canOpenCamera.value }]}
              onClick={() => {
                if (controller.canOpenCamera.value) {
                  controller.toggleCamera("meet-video");
                }
              }}
            >
              {controller.canOpenCamera.value ? controller.cameraState.value ? (
                <Fragment>
                  <Svg
                    svgPath="M234.666667 213.333333A192 192 0 0 0 42.666667 405.333333v256A192 192 0 0 0 234.666667 853.333333h298.666666a192 192 0 0 0 191.616-179.797333l109.525334 74.88c62.293333 42.624 146.858667-2.005333 146.858666-77.482667V396.501333c0-75.733333-85.12-120.32-147.370666-77.098666l-108.928 75.52A192 192 0 0 0 533.333333 213.333333h-298.666666zM725.333333 498.517333v71.893334l157.312 107.562666a8.533333 8.533333 0 0 0 13.354667-7.04V396.501333a8.533333 8.533333 0 0 0-13.397333-6.997333L725.333333 498.517333z m-85.333333-44.672V405.333333A106.666667 106.666667 0 0 0 533.333333 298.666667h-298.666666A106.666667 106.666667 0 0 0 128 405.333333v256A106.666667 106.666667 0 0 0 234.666667 768h298.666666a106.666667 106.666667 0 0 0 106.666667-106.666667v-207.488z"
                    width="20"
                    height="20"
                    class="icon"
                    fill="#dddddd"
                  />
                  <span class="tooltip">关闭摄像头</span>
                </Fragment>
              ) : (
                <Fragment>
                  <Svg
                    svgPath="M640 579.669333l85.333333 85.333334 158.165334 158.165333a42.624 42.624 0 1 1-60.330667 60.330667L699.136 759.466667l-62.08-62.08L238.336 298.666667l-75.093333-75.093334-22.741334-22.741333a42.624 42.624 0 1 1 60.330667-60.330667L273.664 213.333333l85.333333 85.333334L640 579.669333z m256.512-274.773333a73.344 73.344 0 0 0-78.976 13.013333l-92.202667 85.333334V341.333333c0-70.570667-57.386667-128-128-128H333.994667L389.12 268.458667l281.002667 281.002666 85.333333 85.333334 85.76 85.802666a73.216 73.216 0 0 0 55.253333-1.493333c25.984-11.349333 42.154667-35.626667 42.154667-63.317333V368.213333c0-27.733333-16.213333-52.010667-42.154667-63.36z m-289.621333 422.656L208.170667 328.832l-75.093334-75.093333-6.186666-6.186667A127.232 127.232 0 0 0 85.333333 341.333333v341.333334c0 70.613333 57.429333 128 128 128h384c26.325333 0 50.730667-7.978667 71.04-21.632l-61.482666-61.482667z"
                    width="20"
                    height="20"
                    class="icon"
                    fill="#dddddd"
                  />
                  <span class="tooltip">开启摄像头</span>
                </Fragment>
              ) : <Fragment>
                <Svg
                  svgPath="M640 579.669333l85.333333 85.333334 158.165334 158.165333a42.624 42.624 0 1 1-60.330667 60.330667L699.136 759.466667l-62.08-62.08L238.336 298.666667l-75.093333-75.093334-22.741334-22.741333a42.624 42.624 0 1 1 60.330667-60.330667L273.664 213.333333l85.333333 85.333334L640 579.669333z m256.512-274.773333a73.344 73.344 0 0 0-78.976 13.013333l-92.202667 85.333334V341.333333c0-70.570667-57.386667-128-128-128H333.994667L389.12 268.458667l281.002667 281.002666 85.333333 85.333334 85.76 85.802666a73.216 73.216 0 0 0 55.253333-1.493333c25.984-11.349333 42.154667-35.626667 42.154667-63.317333V368.213333c0-27.733333-16.213333-52.010667-42.154667-63.36z m-289.621333 422.656L208.170667 328.832l-75.093334-75.093333-6.186666-6.186667A127.232 127.232 0 0 0 85.333333 341.333333v341.333334c0 70.613333 57.429333 128 128 128h384c26.325333 0 50.730667-7.978667 71.04-21.632l-61.482666-61.482667z"
                  width="20"
                  height="20"
                  class="icon-error"
                  fill="#999999"
                />
                <span class="tooltip">摄像头权限未授予</span>
              </Fragment>}
            </div>
            <div class="operator-item" onClick={() => {
              if (controller.canOpenScreenShare.value) {
                if (controller.screenShareState.value) {
                  // 停止屏幕共享，直接执行
                  controller.stopRemoteScreen();
                } else {
                  // 开启屏幕共享，先弹出确认框
                  $popup.alert("确定要开启屏幕共享吗？", {
                    buttonCount: 2,
                    onBtnRight : () => {
                      controller.startRemoteScreen();
                    },
                  });
                }
              }else {
                $message.warning({
                  message: '其他人正在共享屏幕, 请稍后再试',
                  duration: 2000,
                });
              }
            }}>
              {controller.canOpenScreenShare.value ? controller.screenShareState.value ? <Fragment>
                <Svg
                  svgPath="M905.386667 768.853333l85.333333 85.333334H1024v-85.333334h-118.613333z m32.853333-85.333333l0.426667-426.666667c0-47.36-38.4-85.333333-85.333334-85.333333H308.053333L531.2 394.666667c7.68-1.706667 15.36-2.986667 23.466667-4.266667v-90.88l170.666666 159.146667-67.413333 62.72 236.373333 236.373333a84.586667 84.586667 0 0 0 43.946667-74.24zM101.973333 73.813333L47.36 128 113.066667 193.706667C96 209.066667 85.333333 231.68 85.333333 256.853333v426.666667c0 46.933333 37.973333 85.333333 85.333334 85.333333H0v85.333334h773.546667l115.626666 115.626666 54.186667-54.186666L101.973333 73.813333zM298.666667 640.853333c13.226667-63.146667 39.253333-125.866667 88.32-173.226666l67.84 67.84c-65.706667 16.213333-115.2 50.346667-156.16 105.386666z"
                  width="20"
                  height="20"
                  class="icon"
                  fill="#dddddd"
                />
                <span class="tooltip">结束屏幕共享</span>
              </Fragment> : <Fragment>
                <Svg
                  svgPath="M853.333333 768c46.933333 0 84.906667-38.4 84.906667-85.333333L938.666667 256c0-47.36-38.4-85.333333-85.333334-85.333333H170.666667c-47.36 0-85.333333 37.973333-85.333334 85.333333v426.666667c0 46.933333 37.973333 85.333333 85.333334 85.333333H0v85.333333h1024v-85.333333h-170.666667z m-298.666666-150.613333v-93.44c-118.613333 0-196.693333 36.266667-256 116.053333 23.893333-113.92 90.026667-227.413333 256-250.453333V298.666667l170.666666 159.146666-170.666666 159.573334z"
                  width="20"
                  height="20"
                  class="icon"
                  fill="#dddddd"
                />
                <span class="tooltip">开启屏幕共享</span>
              </Fragment> : <Fragment>
                <Svg
                  svgPath="M853.333333 768c46.933333 0 84.906667-38.4 84.906667-85.333333L938.666667 256c0-47.36-38.4-85.333333-85.333334-85.333333H170.666667c-47.36 0-85.333333 37.973333-85.333334 85.333333v426.666667c0 46.933333 37.973333 85.333333 85.333334 85.333333H0v85.333333h1024v-85.333333h-170.666667z m-298.666666-150.613333v-93.44c-118.613333 0-196.693333 36.266667-256 116.053333 23.893333-113.92 90.026667-227.413333 256-250.453333V298.666667l170.666666 159.146666-170.666666 159.573334z"
                  width="20"
                  height="20"
                  class="icon-error"
                  fill="#999999"
                />
                <span class="tooltip">其他人正在共享屏幕</span>
              </Fragment>}

            </div>
            <div
              class="operator-item"
              onClick={() => {
                const roomId = route.params.roomId as string;
                try {
                  const numericRoomId = $roomformat.roomIdToNumber(roomId);
                  controller.exitMeeting(numericRoomId);
                } catch (error: any) {
                  $message.error({
                    message: '会议ID格式错误: ' + (error?.message || '未知错误'),
                  });
                }
              }}
            >
              <Svg
                svgPath={[
                  "M918.4 489.6l-160-160c-12.8-12.8-32-12.8-44.8 0-12.8 12.8-12.8 32 0 44.8l105.6 105.6L512 480c-19.2 0-32 12.8-32 32s12.8 32 32 32l307.2 0-105.6 105.6c-12.8 12.8-12.8 32 0 44.8 6.4 6.4 12.8 9.6 22.4 9.6 9.6 0 16-3.2 22.4-9.6l160-163.2c0 0 0-3.2 3.2-3.2C931.2 518.4 931.2 499.2 918.4 489.6z",
                  "M832 736c-19.2 0-32 12.8-32 32l0 64c0 19.2-12.8 32-32 32L224 864c-19.2 0-32-12.8-32-32L192 192c0-19.2 12.8-32 32-32l544 0c19.2 0 32 12.8 32 32l0 64c0 19.2 12.8 32 32 32s32-12.8 32-32L864 192c0-54.4-41.6-96-96-96L224 96C169.6 96 128 137.6 128 192l0 640c0 54.4 41.6 96 96 96l544 0c54.4 0 96-41.6 96-96l0-64C864 748.8 851.2 736 832 736z"
                ]}
                width="20"
                height="20"
                class="icon"
                fill="#dddddd"
              />
              <span class="tooltip">退出会议</span>
            </div>
          </div>
        </div>
      </div>
      );
    };
  },
});
